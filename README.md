# Elevator Backend

Backend-сервис для управления вызовом лифта через релейный модуль с поддержкой авторизации по кодам доступа.

## Описание

Это Spring Boot приложение предоставляет REST API для управления лифтом. Система проверяет коды доступа пользователей и отправляет команды на релейный модуль для активации кнопки вызова лифта. Встроена защита от частых вызовов с настраиваемым периодом ожидания между вызовами.

## Технологии

- Java 11
- Spring Boot 2.7.17
- Maven
- Lombok
- Apache Commons IO

## Структура проекта

```
ElevatorBackend/
├── src/
│   └── main/
│       ├── java/
│       │   └── com/example/elevatorbackend/
│       │       ├── ElevatorBackendApplication.java    # Главный класс приложения
│       │       ├── ElevatorExceptionHandler.java      # Глобальный обработчик исключений
│       │       ├── config/
│       │       │   └── ElevatorConfiguration.java     # Конфигурация бинов
│       │       └── controller/
│       │           └── ElevatorController.java        # REST контроллер
│       └── resources/
│           └── application.properties                 # Настройки приложения
├── cooldown.txt                                      # Файл с периодом ожидания
├── ids.txt                                          # Файл с разрешенными кодами доступа
├── pom.xml                                          # Maven конфигурация
└── .gitignore
```

## API Endpoints

### POST /post
Вызов лифта с проверкой кода доступа.

**Параметры запроса:**
- `code` (обязательный) - код доступа пользователя
- `relay` (обязательный) - номер реле для активации

**Ответы:**
- `1` - неверный код доступа или ошибка
- `2` - лифт успешно вызван
- `300 + оставшееся_время` - нужно подождать перед следующим вызовом

**Пример запроса:**
```bash
curl -X POST "http://localhost:8083/post?code=123456&relay=1"
```

## Конфигурация

### application.properties

```properties
relay.ip=192.168.2.14              # IP-адрес релейного модуля
server.port=8083                   # Порт приложения
spring.web.resources.add-mappings=false
spring.mvc.throw-exception-if-no-handler-found=true
```

### Внешние файлы конфигурации

#### ids.txt
Текстовый файл со списком разрешенных кодов доступа (по одному коду на строку):
```
123456
789012
345678
```

#### cooldown.txt
Текстовый файл с одним числом - периодом ожидания между вызовами в секундах:
```
30
```
По умолчанию: 60 секунд (если файл не найден или не читается)

## Логика работы

1. **Проверка кода доступа**: При получении запроса система проверяет наличие кода в файле `ids.txt`
2. **Проверка cooldown**: Система не позволяет вызывать лифт чаще, чем указано в `cooldown.txt`
3. **Отправка команды на реле**: При успешной проверке отправляется HTTP-запрос на релейный модуль
4. **Параметры команды реле**:
    - `type=1` - тип операции
    - `relay={номер}` - номер реле из запроса
    - `on=1` - включить реле
    - `time=5` - время активации в секундах
    - `pwd=3789` - пароль для доступа к реле

## Сборка и запуск

### Требования
- JDK 11 или выше
- Maven 3.6+

### Сборка
```bash
mvn clean package
```

### Запуск
```bash
# Через Maven
mvn spring-boot:run

# Через JAR
java -jar target/elevator-backend.jar

# С внешними параметрами
java -jar target/elevator-backend.jar --server.port=8080 --relay.ip=192.168.1.100
```

### Сборка JAR с зависимостями
```bash
mvn clean compile assembly:single
```

## Обработка ошибок

Все исключения перехватываются глобальным обработчиком `ElevatorExceptionHandler`, который:
- Логирует ошибку в консоль
- Возвращает код `1` (ошибка) с HTTP статусом 200

## Логирование

Приложение использует SLF4J с Logback. Основные события:
- Информация о каждом вызове лифта
- Ошибки при неверных кодах
- Предупреждения при слишком частых вызовах
- Ошибки чтения конфигурационных файлов

Для включения детального логирования раскомментируйте в `application.properties`:
```properties
logging.level.root=TRACE
```

## Безопасность

- Коды доступа хранятся в локальном файле `ids.txt`
- Пароль для релейного модуля захардкожен в коде (рекомендуется вынести в конфигурацию)
- Нет шифрования трафика между сервисом и релейным модулем
